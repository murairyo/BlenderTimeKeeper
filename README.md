# TimeKeeper - Blender作業時間計測アドオン

## 概要

TimeKeeperは、Blenderでの作業時間を自動的に計測し、ステータスバー（画面の右下）に表示するアドオンです。作業時間は累積され、ファイル保存時に一緒に保存されるため、別名保存やファイル再読み込み後も作業時間が引き継がれます。

## 機能

### ✅ 実装済み機能

- **自動時間計測**: Blenderを開いている間の作業時間を自動計測
- **累積時間表示**: ステータスバーに「作業時間: HH:MM:SS」形式で表示
- **データ永続化**: ファイル保存時に作業時間を.blendファイルに保存
- **別名保存対応**: 別名保存時も作業時間が引き継がれる
- **正確な時間管理**: 10秒間隔での定期累積更新により重複計算を防止
- **デバッグ機能**: 問題発生時の詳細ログ出力（設定で制御可能）

### 🔧 技術的特徴

- **重複計算防止**: セーブ時の時間加算重複を完全に防ぐ設計
- **安定性**: 包括的なエラーハンドリングと適切なリソース管理
- **拡張性**: モジュール化された設計で、将来的な機能追加が容易
- **軽量性**: 最小限のシステムリソース使用

## ⚠️ 重要な制約事項

### Blenderの設計による表示更新の制約

**時間表示はユーザー操作時にのみ更新されます。**

これはBlenderの根本的な設計仕様です：

- **イベントドリブンシステム**: BlenderのUIは、マウス移動・キー入力・オブジェクト選択などのユーザー操作があった時のみ画面を再描画します
- **パフォーマンス最適化**: CPUとGPUリソースを節約するための意図的な設計
- **アドオンの制約**: この制約はアドオン側では完全には解決できません

### 実際の動作

- ✅ **時間計測**: バックグラウンドで正確に継続されています
- ✅ **データ保存**: 10秒間隔で確実に累積時間が更新されます
- ⚠️ **表示更新**: オブジェクト選択や何らかの操作をした時に表示が更新されます

### 対策

- 軽微な操作（モード切り替えやオブジェクト選択）で表示が更新されます
- 時間計測自体は正確に継続されているため、操作時に正しい時間が表示されます

## インストール方法

1. `time_keeper.py` ファイルをBlenderのアドオンフォルダにコピーするか、Blenderの設定からアドオンとしてインストール
2. 編集 > プリファレンス > アドオン > System > "TimeKeeper - 作業時間計測"にチェックを入れる
3. インストール完了！アドオンが有効化されると自動的に計測が開始されます

## 使用方法

### 基本操作

1. **自動開始**: アドオンが有効化されると、自動的に時間計測が開始されます
2. **時間確認**: ステータスバー（画面下部）に「作業時間: 00:00:00」形式で表示されます
3. **保存**: ファイルを保存すると、作業時間も一緒に保存されます
4. **引き継ぎ**: ファイルを再度開くと、保存された作業時間から継続されます

### ファイル操作での動作

- **新規ファイル**: 00:00:00から計測開始
- **ファイル読み込み**: 保存されていた作業時間から継続
- **別名保存**: 現在の作業時間を新しいファイルに引き継ぎ
- **ファイル切り替え**: 各ファイルごとに独立した時間管理

### 表示更新について

時間表示を更新するには、以下のような軽微な操作を行ってください：

- オブジェクトの選択
- キーボードの操作
- モードの切り替え
- パネルの開閉

## コードアーキテクチャ

### 主要コンポーネント

```
TimeKeeperData (PropertyGroup)
├── total_time: 累積作業時間
└── session_start_time: セッション開始時刻

TimeKeeperManager (Class)
├── start_session(): セッション開始
├── stop_session(): セッション停止
├── get_current_total_time(): 現在の累積時間取得
├── _periodic_update_total_time(): 定期的な累積時間更新
└── _timer_callback(): UI更新トリガー

TIMEKEEPER_OT_Modal (Operator)
└── modal(): バックグラウンドUI更新

Event Handlers
├── load_pre_handler: ファイル読み込み前
├── load_post_handler: ファイル読み込み後
└── save_pre_handler: ファイル保存前（リセットのみ）
```

### 時間管理の仕組み

1. **定期累積更新**: 10秒間隔で確実に累積時間を更新
2. **表示計算**: リアルタイムで現在の作業時間を計算（最後の更新からの経過時間を追加）
3. **重複防止**: セーブ時は時間加算せず、session_start_timeのリセットのみ
4. **最終更新**: セッション停止時に残り時間を累積に追加

## デバッグ機能

コード内の `DEBUG_MODE` フラグで詳細ログを制御できます：

```python
DEBUG_MODE = True   # 詳細ログを出力
DEBUG_MODE = False  # 最小限のログのみ
```

### デバッグログの例

```
TimeKeeper: Session started successfully
TimeKeeper: Periodic update - Added 10.0s, Total: 125.0s
TimeKeeper: Save - Current session: 5.2s, Total: 130.2s
TimeKeeper: Save - Session time reset for continuity
```

## 技術仕様

- **Blender対応バージョン**: 3.0.0以上
- **Python**: Blender内蔵のPythonを使用
- **データ保存**: .blendファイル内のカスタムプロパティとして保存
- **累積更新頻度**: 10秒間隔
- **UI更新頻度**: 0.3秒間隔（操作時のみ実際に表示更新）
- **メモリ使用量**: 最小限（タイマーとデータプロパティのみ）

## 注意事項

### 時間計測について

- ✅ Blenderを最小化した状態でも時間計測は正確に継続されます
- ✅ 複数のBlenderインスタンスを開いている場合、各インスタンスで独立して計測されます
- ✅ 作業時間はBlenderファイルと一緒に保存されるため、ファイルサイズにわずかな影響があります（数バイト程度）

### 表示について

- ⚠️ **表示更新はユーザー操作時のみ**: これはBlenderの設計仕様です
- ✅ **時間計測は正確**: 表示が更新されていなくても、バックグラウンドで正確に計測されています
- 💡 **表示更新方法**: マウスを少し動かすなどの軽微な操作で表示が更新されます

### パフォーマンス

- 軽量設計により、Blenderの動作に影響を与えません
- タイマー処理は最適化されており、CPU使用量は最小限です

## トラブルシューティング

### 時間が表示されない

1. ステータスバー（画面下部）を確認してください
2. 何らかの操作（マウス移動等）を行って表示を更新してください
3. デバッグモードを有効にしてコンソールでログを確認してください

### 時間が急激に増加する

- この問題は修正済みです（重複計算防止機能により解決）
- もし発生した場合は、アドオンを再読み込みしてください

### アドオンが動作しない

1. Blender 3.0.0以上を使用していることを確認
2. アドオンが有効化されていることを確認
3. コンソール（Window > Toggle System Console）でエラーログを確認

## 今後の拡張予定（参考）

以下の機能は拡張性を考慮して実装が容易になっています：

- プロジェクト別時間管理
- 詳細統計情報表示
- CSV/JSONエクスポート機能
- 作業時間目標設定
- 休憩時間の自動検出
- タイムライン表示
- より高度なUI更新方法の実装

---

## ライセンス

このアドオンは拡張と改変が可能な設計になっています。 